#!/bin/bash

# ==========================================
# Kiro CLI + MCPs Setup (v5.0 - Final)
# ==========================================

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

clear
echo -e "${BLUE}=========================================${NC}"
echo -e "${BLUE}   üöÄ Kiro CLI + MCPs Setup (v5)     ${NC}"
echo -e "${BLUE}=========================================${NC}"
echo ""

# 1. Environment Checks
echo -e "${BLUE}üîç Checking environment...${NC}"

# Ensure ~/.local/bin is in PATH
export PATH="$HOME/.local/bin:$PATH"

# Find absolute path for npx (Crucial for Codespaces)
NPX_PATH=$(which npx)
if [ -z "$NPX_PATH" ]; then
    echo -e "${RED}‚ùå 'npx' not found! Please install Node.js first.${NC}"
    exit 1
fi
echo -e "   ‚Ä¢ Found npx at: ${GREEN}$NPX_PATH${NC}"

# Check for kiro-cli
if ! command -v kiro-cli &> /dev/null; then
    echo -e "${RED}‚ùå 'kiro-cli' not found.${NC}"
    exit 1
fi
echo -e "   ‚Ä¢ Found kiro-cli version: ${GREEN}$(kiro-cli --version)${NC}"


# 2. Interactive API Key Setup (Restored)
echo -e "\n${BLUE}üîë API Key Configuration${NC}"
echo "   (Press Enter to skip any key you don't have)"

# Function to ask for key and export it
setup_key() {
    local var_name=$1
    local prompt_name=$2
    local current_val=${!var_name}

    if [ -n "$current_val" ]; then
        echo -e "   ‚Ä¢ $prompt_name: ${GREEN}Detected in environment${NC}"
    else
        read -p "   > Enter $prompt_name API Key: " user_key
        if [ -n "$user_key" ]; then
            export "$var_name"="$user_key"
            # Persist to bashrc
            if ! grep -q "export $var_name=" ~/.bashrc; then
                echo "export $var_name=\"$user_key\"" >> ~/.bashrc
            fi
            echo -e "     ${GREEN}‚úì Set and saved to ~/.bashrc${NC}"
        else
            echo -e "     ${YELLOW}‚ö† Skipped${NC}"
        fi
    fi
}

setup_key "CONTEXT7_API_KEY" "Context7"
setup_key "REF_API_KEY" "Ref Tools"
setup_key "EXA_API_KEY" "Exa Search"


# 3. Configure Kiro Settings (Requested Updates)
echo -e "\n${BLUE}‚öôÔ∏è  Configuring Kiro Settings...${NC}"

# Set specific 4.5 model
echo -n "   ‚Ä¢ Setting default model to claude-sonnet-4.5... "
if kiro-cli settings chat.defaultModel claude-sonnet-4.5 > /dev/null 2>&1; then
    echo -e "${GREEN}‚úì OK${NC}"
else
    echo -e "${YELLOW}‚ö† Failed (Check kiro-cli version)${NC}"
fi

# Set MCP Timeout to 20s (20000ms)
echo -n "   ‚Ä¢ Setting MCP init timeout to 20s... "
if kiro-cli settings mcp.initTimeout 20000 > /dev/null 2>&1; then
    echo -e "${GREEN}‚úì OK${NC}"
else
    echo -e "${YELLOW}‚ö† Failed${NC}"
fi

# Enable capability flags
kiro-cli settings chat.enableKnowledge true > /dev/null 2>&1
kiro-cli settings chat.enableThinking true > /dev/null 2>&1
kiro-cli settings chat.enableCheckpoint true > /dev/null 2>&1


# 4. Install MCPs
echo -e "\n${BLUE}üì¶ Installing MCP Servers...${NC}"

install_mcp() {
    local name=$1
    local package=$2
    local args=$3

    echo -n "   ‚Ä¢ Adding $name... "

    # Pre-install package silently
    npm install -g "$package" --quiet --no-audit --no-fund > /dev/null 2>&1

    # Add to Kiro using ABSOLUTE path
    OUTPUT=$(kiro-cli mcp add --name "$name" --command "$NPX_PATH" --args "$args" --force 2>&1)
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}‚úì OK${NC}"
    else
        echo -e "${RED}FAILED${NC}"
        echo -e "     Error: $OUTPUT"
    fi
}

# Chrome DevTools
install_mcp "chrome-devtools" \
    "chrome-devtools-mcp@latest" \
    "-y,chrome-devtools-mcp@latest,--headless=true,--isolated=true"

# Sequential Thinking
install_mcp "sequential_thinking" \
    "@modelcontextprotocol/server-sequential-thinking@latest" \
    "-y,@modelcontextprotocol/server-sequential-thinking@latest"

# Context7
if [ -n "$CONTEXT7_API_KEY" ]; then
    install_mcp "context7" "@upstash/context7-mcp@latest" "-y,@upstash/context7-mcp@latest,--api-key,$CONTEXT7_API_KEY"
else
    echo -e "   ‚Ä¢ ${YELLOW}Skipping context7${NC} (No key provided)"
fi

# Ref Tools
if [ -n "$REF_API_KEY" ]; then
    install_mcp "ref" "ref-tools-mcp@latest" "-y,ref-tools-mcp@latest"
else
    echo -e "   ‚Ä¢ ${YELLOW}Skipping ref${NC} (No key provided)"
fi

# Exa
if [ -n "$EXA_API_KEY" ]; then
    install_mcp "exa" "exa-mcp-server@latest" "-y,exa-mcp-server@latest"
else
    echo -e "   ‚Ä¢ ${YELLOW}Skipping exa${NC} (No key provided)"
fi


# 5. Final Verification
echo -e "\n${BLUE}üîç Verification:${NC}"
kiro-cli mcp list

echo -e "\n${GREEN}‚úÖ Setup Complete!${NC}"
echo -e "   Run ${BLUE}source ~/.bashrc${NC} to apply environment variables."
echo -e "   Start Kiro with: ${BLUE}kiro-cli${NC}"
