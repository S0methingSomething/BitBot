#!/bin/bash

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}ğŸš€ Amazon Q CLI + MCPs Setup Script (Version 3)${NC}"
echo ""

# Source existing bashrc to load current environment variables
[ -f ~/.bashrc ] && source ~/.bashrc

# Detect OS and distro
detect_os() {
    if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        if [ -f /etc/os-release ]; then
            OS=$(awk -F= '/^ID=/{gsub(/"/, "", $2); print $2}' /etc/os-release)
            VERSION=$(awk -F= '/^VERSION_ID=/{gsub(/"/, "", $2); print $2}' /etc/os-release)
        fi
        if [ -z "$OS" ] && command -v lsb_release >/dev/null; then
            OS=$(lsb_release -si | tr '[:upper:]' '[:lower:]')
        fi
        if [ -z "$OS" ]; then
            OS="unknown"
        fi
        echo "linux"
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        echo "macos"
    elif [[ "$OSTYPE" == "msys" ]] || [[ "$OSTYPE" == "cygwin" ]]; then
        echo "windows"
    else
        echo "unknown"
    fi
}

OS_TYPE=$(detect_os)
echo -e "${BLUE}ğŸ“‹ Detected OS: $OS_TYPE${NC}"
if [ "$OS_TYPE" == "linux" ]; then
    echo -e "${BLUE}ğŸ“‹ Detected Distro: $OS${NC}"
fi
echo ""

# Check architecture
ARCH=$(uname -m)
if [ "$ARCH" != "x86_64" ]; then
    echo -e "${YELLOW}âš  Warning: This script is optimized for x86_64 architecture. Proceeding with caution.${NC}"
fi

# Function to get package manager
get_package_manager() {
    if [ "$OS" == "ubuntu" ] || [ "$OS" == "debian" ]; then
        echo "apt"
    elif [ "$OS" == "fedora" ]; then
        echo "dnf"
    else
        echo "unknown"
    fi
}

PKG_MGR=$(get_package_manager)
if [ "$OS_TYPE" == "linux" ] && [ "$PKG_MGR" == "unknown" ]; then
    echo -e "${RED}âŒ Unsupported Linux distribution: $OS. This script supports Ubuntu/Debian and Fedora.${NC}"
    exit 1
fi

# Function to check if Amazon Q is installed
check_q_installed() {
    if command -v q &> /dev/null; then
        echo -e "${GREEN}âœ“ Amazon Q CLI is already installed${NC}"
        q --version
        return 0
    else
        echo -e "${YELLOW}âš  Amazon Q CLI is not installed${NC}"
        return 1
    fi
}

# Function to install Amazon Q CLI based on OS
install_amazon_q() {
    echo -e "${BLUE}ğŸ“¦ Installing Amazon Q CLI for $OS_TYPE...${NC}"
    
    case $OS_TYPE in
        "macos")
            echo "Installing via Homebrew..."
            if ! command -v brew &> /dev/null; then
                echo -e "${RED}âŒ Homebrew not found. Please install Homebrew first.${NC}"
                echo "Visit: https://brew.sh"
                exit 1
            fi
            brew install --cask amazon-q
            echo -e "${YELLOW}âš  After installation, open the Amazon Q app from Applications and enable shell integrations for CLI access.${NC}"
            ;;
            
        "linux")
            echo "Installing minimal CLI via Zip (suitable for headless)..."
            cd /tmp
            
            # Download and install
            echo "Downloading Amazon Q CLI..."
            wget -q --show-progress https://desktop-release.q.us-east-1.amazonaws.com/latest/q-x86_64-linux.zip -O q.zip
            
            # Check if download was successful
            if [ ! -f q.zip ]; then
                echo -e "${RED}âŒ Failed to download Amazon Q CLI${NC}"
                exit 1
            fi
            
            # Install unzip if needed
            if ! command -v unzip &> /dev/null; then
                echo "Installing unzip..."
                if [ "$PKG_MGR" == "apt" ]; then
                    sudo apt-get update -qq
                    sudo apt-get install -y unzip
                elif [ "$PKG_MGR" == "dnf" ]; then
                    sudo dnf install -y unzip
                fi
            fi
            
            echo "Extracting..."
            unzip -q q.zip
            cd q
            chmod +x install.sh
            
            # Run installer
            echo "Running installer (will ask to modify shell config - answer 'Yes')..."
            ./install.sh
            
            # Clean up
            cd /tmp
            rm -rf q q.zip
            
            # Source shell config to make q available immediately
            [ -f ~/.bashrc ] && source ~/.bashrc
            
            # Update PATH for current session
            export PATH="$HOME/.local/bin:$PATH"
            
            ;;
            
        "windows")
            echo -e "${YELLOW}âš  Windows detected. Amazon Q CLI requires WSL (Windows Subsystem for Linux)${NC}"
            echo "Please ensure WSL is installed and run this script from within WSL (Ubuntu or similar)."
            echo "Guide: https://dev.to/aws/the-essential-guide-to-installing-amazon-q-developer-cli-on-windows-lmh"
            exit 1
            ;;
            
        *)
            echo -e "${RED}âŒ Unsupported operating system: $OS_TYPE${NC}"
            exit 1
            ;;
    esac
    
    echo -e "${GREEN}âœ“ Amazon Q CLI installed successfully${NC}"
}

# Function to check if user is logged in
check_q_login() {
    echo -e "${BLUE}ğŸ” Checking Amazon Q login status...${NC}"
    
    # Make sure q is in PATH
    export PATH="$HOME/.local/bin:$PATH"
    
    # Run q whoami to check login status
    if q whoami &> /dev/null; then
        echo -e "${GREEN}âœ“ Already logged in to Amazon Q${NC}"
        q whoami
        return 0
    else
        echo -e "${YELLOW}âš  Not logged in to Amazon Q${NC}"
        return 1
    fi
}

# Function to login to Amazon Q
login_amazon_q() {
    echo -e "${BLUE}ğŸ”‘ Logging in to Amazon Q...${NC}"
    echo "Please follow the authentication flow in your browser."
    echo ""
    
    # Make sure q is in PATH
    export PATH="$HOME/.local/bin:$PATH"
    
    q login
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}âœ“ Successfully logged in to Amazon Q${NC}"
    else
        echo -e "${RED}âŒ Login failed${NC}"
        exit 1
    fi
}

# Function to check and install Node.js/npm
check_nodejs() {
    echo -e "${BLUE}ğŸ“¦ Checking Node.js and npm...${NC}"
    
    if command -v node &> /dev/null && command -v npm &> /dev/null; then
        echo -e "${GREEN}âœ“ Node.js $(node --version) and npm $(npm --version) already installed${NC}"
        return 0
    else
        echo -e "${YELLOW}âš  Node.js/npm not found, installing...${NC}"
        install_nodejs
    fi
}

# Function to install Node.js based on OS
install_nodejs() {
    case $OS_TYPE in
        "macos")
            if command -v brew &> /dev/null; then
                brew install node
            else
                echo -e "${RED}âŒ Homebrew required. Install from https://brew.sh${NC}"
                exit 1
            fi
            ;;
            
        "linux")
            # Install Node.js 20.x LTS
            echo "Installing Node.js 20.x LTS..."
            if [ "$PKG_MGR" == "apt" ]; then
                curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
                sudo apt-get install -y nodejs
            elif [ "$PKG_MGR" == "dnf" ]; then
                curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo -E bash -
                sudo dnf install -y nodejs
            fi
            ;;
            
        *)
            echo -e "${RED}âŒ Cannot auto-install Node.js on this system${NC}"
            echo "Please install Node.js manually from https://nodejs.org"
            exit 1
            ;;
    esac
    
    echo -e "${GREEN}âœ“ Node.js and npm installed successfully${NC}"
}

# Function to pre-install MCP packages globally if not already installed
preinstall_mcp_packages() {
    echo -e "${BLUE}ğŸ“¦ Pre-installing MCP packages globally...${NC}"
    echo "This ensures faster startup times and better reliability."
    echo ""
    
    local packages=(
        "chrome-devtools-mcp@latest"
        "@modelcontextprotocol/server-sequential-thinking@latest"
        "@upstash/context7-mcp@latest"
        "ref-tools-mcp@latest"
        "exa-mcp-server@latest"
    )
    
    for package in "${packages[@]}"; do
        local pkg_name="${package%%@*}"
        if npm list -g "$pkg_name" &> /dev/null; then
            echo -e "  ${GREEN}âœ“ $pkg_name already installed${NC}"
        else
            echo "  Installing $pkg_name..."
            npm install -g "$package" --quiet 2>&1 | grep -v "npm WARN" || true
            echo -e "${GREEN}  âœ“ $pkg_name installed${NC}"
        fi
    done
    
    echo ""
    echo -e "${GREEN}âœ“ All MCP packages pre-installed${NC}"
}

# Function to check MCP server status
check_mcp_status() {
    local server_name=$1
    
    # Make sure q is in PATH
    export PATH="$HOME/.local/bin:$PATH"
    
    # Use q mcp list and check if server exists
    if q mcp list 2>/dev/null | grep -q "$server_name"; then
        echo -e "  ${GREEN}âœ“${NC} $server_name"
        return 0
    else
        echo -e "  ${YELLOW}âš ${NC} $server_name (not found, may need to be added)"
        return 1
    fi
}

# Function to configure Q CLI settings
configure_q_settings() {
    echo -e "${BLUE}âš™ï¸  Configuring Amazon Q CLI settings...${NC}"
    
    # Make sure q is in PATH
    export PATH="$HOME/.local/bin:$PATH"
    
    q settings chat.defaultModel claude-sonnet-4.5 2>&1 > /dev/null && echo -e "${GREEN}  âœ“ Default model: claude-sonnet-4.5${NC}" || echo -e "${YELLOW}  âš  Could not set default model${NC}"
    
    q settings chat.enableKnowledge true 2>&1 > /dev/null && echo -e "${GREEN}  âœ“ Knowledge enabled${NC}" || echo -e "${YELLOW}  âš  Could not enable knowledge${NC}"
    
    q settings chat.enableThinking true 2>&1 > /dev/null && echo -e "${GREEN}  âœ“ Thinking enabled${NC}" || echo -e "${YELLOW}  âš  Could not enable thinking${NC}"
    
    q settings chat.enableCheckpoint true 2>&1 > /dev/null && echo -e "${GREEN}  âœ“ Checkpoint enabled${NC}" || echo -e "${YELLOW}  âš  Could not enable checkpoint${NC}"
    
    q settings chat.enableContextUsageIndicator true 2>&1 > /dev/null && echo -e "${GREEN}  âœ“ Context usage indicator enabled${NC}" || echo -e "${YELLOW}  âš  Could not enable context usage indicator${NC}"
    
    echo ""
    echo -e "${GREEN}âœ“ All settings configured${NC}"
}

# ===== MAIN SCRIPT =====

# Step 1: Check and install Amazon Q CLI
if ! check_q_installed; then
    install_amazon_q
fi

# Make sure q is in PATH for the rest of the script
export PATH="$HOME/.local/bin:$PATH"

echo ""

# Step 2: Check and perform login
if ! check_q_login; then
    login_amazon_q
fi

echo ""

# Step 3: Check and install Node.js/npm
check_nodejs

echo ""

# Step 4: Pre-install MCP packages
preinstall_mcp_packages

echo ""

# Step 5: Install Chrome (for chrome-devtools MCP) on Linux
if [ "$OS_TYPE" == "linux" ]; then
    echo -e "${BLUE}ğŸ“¦ Installing Chrome for headless mode...${NC}"
    if command -v google-chrome &> /dev/null; then
        echo -e "${GREEN}âœ“ Chrome already installed${NC}"
    else
        if [ "$PKG_MGR" == "apt" ]; then
            sudo apt-get update -qq
            wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
            sudo dpkg -i google-chrome-stable_current_amd64.deb || true
            sudo apt-get install -f -y
            rm google-chrome-stable_current_amd64.deb
        elif [ "$PKG_MGR" == "dnf" ]; then
            sudo dnf install -y https://dl.google.com/linux/direct/google-chrome-stable_current_x86_64.rpm
        fi
        # Install dependencies if needed
        if [ "$PKG_MGR" == "apt" ]; then
            sudo apt-get install -y libgbm1 libnss3 libxss1 libasound2t64
        elif [ "$PKG_MGR" == "dnf" ]; then
            sudo dnf install -y libgbm libnss3 libXss libasound2
        fi
        echo -e "${GREEN}âœ“ Chrome installed${NC}"
    fi
    echo ""
fi

# Step 6: API Key Setup (skip prompt if already set)
echo -e "${BLUE}ğŸ”‘ API Key Setup${NC}"
echo ""
echo "The following MCP servers require API keys:"
echo "â€¢ Context7: Get your key from https://context7.com/dashboard"
echo "â€¢ Ref: Get your key from https://ref.tools"
echo "â€¢ Exa: Get your key from https://dashboard.exa.ai/api-keys"
echo ""

if [ -z "${CONTEXT7_API_KEY}" ]; then
    while true; do
        read -p "Enter your Context7 API key: " CONTEXT7_API_KEY
        if [ -n "${CONTEXT7_API_KEY}" ]; then
            break
        fi
        echo -e "${RED}Context7 API key is required!${NC}"
    done
else
    echo -e "${GREEN}âœ“ Context7 API key already set${NC}"
fi

if [ -z "${REF_API_KEY}" ]; then
    while true; do
        read -p "Enter your Ref API key: " REF_API_KEY
        if [ -n "${REF_API_KEY}" ]; then
            break
        fi
        echo -e "${RED}Ref API key is required!${NC}"
    done
else
    echo -e "${GREEN}âœ“ Ref API key already set${NC}"
fi

if [ -z "${EXA_API_KEY}" ]; then
    while true; do
        read -p "Enter your Exa API key: " EXA_API_KEY
        if [ -n "${EXA_API_KEY}" ]; then
            break
        fi
        echo -e "${RED}Exa API key is required!${NC}"
    done
else
    echo -e "${GREEN}âœ“ Exa API key already set${NC}"
fi

echo ""

# Export keys to bashrc (overwrite section)
sed -i '/# MCP API Keys/,/^$/d' ~/.bashrc 2>/dev/null || true

echo "" >> ~/.bashrc
echo "# MCP API Keys" >> ~/.bashrc
echo "export CONTEXT7_API_KEY=\"${CONTEXT7_API_KEY}\"" >> ~/.bashrc
echo "export REF_API_KEY=\"${REF_API_KEY}\"" >> ~/.bashrc
echo "export EXA_API_KEY=\"${EXA_API_KEY}\"" >> ~/.bashrc
echo "" >> ~/.bashrc

echo -e "${GREEN}âœ“ API keys configured and saved to ~/.bashrc${NC}"
echo ""

# Step 6.5: Verify q command is available
echo -e "${BLUE}ğŸ” Verifying q command is available...${NC}"

if ! command -v q &> /dev/null; then
    echo -e "${YELLOW}âš  q command not found in current PATH${NC}"
    echo "Attempting to locate q binary..."
    
    # Try common installation paths
    if [ -f "$HOME/.local/bin/q" ]; then
        export PATH="$HOME/.local/bin:$PATH"
        echo -e "${GREEN}âœ“ Found q at ~/.local/bin/q${NC}"
        echo -e "${GREEN}âœ“ Added ~/.local/bin to PATH${NC}"
    elif [ -f "/usr/local/bin/q" ]; then
        export PATH="/usr/local/bin:$PATH"
        echo -e "${GREEN}âœ“ Found q at /usr/local/bin/q${NC}"
    else
        echo -e "${RED}âŒ Could not locate q binary${NC}"
        echo -e "${RED}âŒ Please restart your terminal and run: source ~/.bashrc${NC}"
        echo -e "${RED}âŒ Then manually run the MCP add commands shown in the summary${NC}"
        echo ""
        echo "You can add MCPs manually with:"
        echo "  source ~/.bashrc"
        echo "  q mcp add --name chrome-devtools --command npx --args \"-y,chrome-devtools-mcp@latest,--headless=true,--isolated=true\" --force"
        echo "  q mcp add --name sequential_thinking --command npx --args \"-y,@modelcontextprotocol/server-sequential-thinking\" --force"
        echo "  q mcp add --name context7 --command npx --args \"-y,@upstash/context7-mcp,--api-key,\$CONTEXT7_API_KEY\" --force"
        echo "  q mcp add --name ref --command npx --args \"-y,ref-tools-mcp@latest\" --force"
        echo "  q mcp add --name exa --command npx --args \"-y,exa-mcp-server@latest\" --force"
        exit 1
    fi
fi

# Verify q works
if q --version &> /dev/null; then
    echo -e "${GREEN}âœ“ q command is working ($(q --version))${NC}"
else
    echo -e "${RED}âŒ q command found but not working properly${NC}"
    exit 1
fi

echo ""

# Step 7: Add all MCP servers to Q CLI
echo -e "${BLUE}ğŸ”§ Adding MCP servers to Q CLI...${NC}"

echo "  Adding chrome-devtools..."
q mcp add --name chrome-devtools --command npx --args "-y,chrome-devtools-mcp@latest,--headless=true,--isolated=true" --force 2>&1 > /dev/null && echo -e "${GREEN}  âœ“ chrome-devtools${NC}" || echo -e "${YELLOW}  âš  Failed to add chrome-devtools${NC}"

echo "  Adding sequential_thinking..."
q mcp add --name sequential_thinking --command npx --args "-y,@modelcontextprotocol/server-sequential-thinking" --force 2>&1 > /dev/null && echo -e "${GREEN}  âœ“ sequential_thinking${NC}" || echo -e "${YELLOW}  âš  Failed to add sequential_thinking${NC}"

echo "  Adding context7..."
q mcp add --name context7 --command npx --args "-y,@upstash/context7-mcp,--api-key,${CONTEXT7_API_KEY}" --force 2>&1 > /dev/null && echo -e "${GREEN}  âœ“ context7 (with API key)${NC}" || echo -e "${YELLOW}  âš  Failed to add context7${NC}"

echo "  Adding ref..."
q mcp add --name ref --command npx --args "-y,ref-tools-mcp@latest" --force 2>&1 > /dev/null && echo -e "${GREEN}  âœ“ ref${NC}" || echo -e "${YELLOW}  âš  Failed to add ref${NC}"

echo "  Adding exa..."
q mcp add --name exa --command npx --args "-y,exa-mcp-server@latest" --force 2>&1 > /dev/null && echo -e "${GREEN}  âœ“ exa (web search & research)${NC}" || echo -e "${YELLOW}  âš  Failed to add exa${NC}"

echo ""

# Step 8: Verify MCP Server Configuration
echo -e "${BLUE}ğŸ“Š Verifying MCP Server Configuration...${NC}"

for mcp in chrome-devtools sequential_thinking context7 ref exa; do
    check_mcp_status "$mcp"
done

echo ""

# Step 9: List all MCPs
echo -e "${BLUE}ğŸ“‹ All configured MCP servers:${NC}"
q mcp list || echo -e "${YELLOW}âš  Could not list MCPs${NC}"

echo ""

# Step 10: Configure all Q settings
configure_q_settings

echo ""

# Step 11: Update bashrc to auto-trust all MCP tools
echo -e "${BLUE}ğŸ”“ Configuring auto-trust for MCP tools...${NC}"
sed -i "/^q() {/,/^}/d" ~/.bashrc 2>/dev/null || true

cat << 'EOF' >> ~/.bashrc

# Auto-trust all MCP tools
q() {
  if [ $# -eq 0 ]; then
    command q chat --trust-tools @*/*
  else
    command q "$@"
  fi
}
EOF

echo -e "${GREEN}âœ“ Auto-trust configured${NC}"
echo ""

# Final summary
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}âœ… Setup Complete!${NC}"
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo -e "${BLUE}ğŸ“‹ Summary:${NC}"
echo "  âœ“ Amazon Q CLI installed and configured"
echo "  âœ“ Logged in to Amazon Q"
echo "  âœ“ Node.js and npm installed"
echo "  âœ“ MCP packages pre-installed globally"
if [ "$OS_TYPE" == "linux" ]; then
    echo "  âœ“ Chrome installed (headless mode)"
fi
echo "  âœ“ Context7 API key configured"
echo "  âœ“ Ref API key configured"
echo "  âœ“ Exa API key configured"
echo ""
echo -e "${BLUE}ğŸ”§ MCP Servers Added:${NC}"
echo "  â€¢ chrome-devtools - Browser automation and performance"
echo "  â€¢ sequential_thinking - Step-by-step reasoning"
echo "  â€¢ context7 - Up-to-date documentation (with API key)"
echo "  â€¢ ref - Reference documentation (with API key)"
echo "  â€¢ exa - Web search, research papers, company research, LinkedIn search"
echo ""
echo -e "${BLUE}ğŸŒ Exa Tools Available:${NC}"
echo "  â€¢ web_search_exa - Real-time web search"
echo "  â€¢ research_paper_search - Academic paper search"
echo "  â€¢ company_research - Company information"
echo "  â€¢ crawling - Extract content from URLs"
echo "  â€¢ competitor_finder - Find competitors"
echo "  â€¢ linkedin_search - Search LinkedIn"
echo "  â€¢ wikipedia_search_exa - Wikipedia search"
echo ""
echo -e "${BLUE}âš™ï¸  Q CLI Settings:${NC}"
echo "  â€¢ Default model: claude-sonnet-4.5"
echo "  â€¢ Knowledge: enabled"
echo "  â€¢ Thinking: enabled"
echo "  â€¢ Checkpoint: enabled"
echo "  â€¢ Context usage indicator: enabled"
echo "  â€¢ All MCP tools: auto-trusted"
echo ""
echo -e "${BLUE}ğŸ“¦ Installed Packages:${NC}"
echo "  â€¢ chrome-devtools-mcp"
echo "  â€¢ @modelcontextprotocol/server-sequential-thinking"
echo "  â€¢ @upstash/context7-mcp"
echo "  â€¢ ref-tools-mcp"
echo "  â€¢ exa-mcp-server"
echo ""
echo -e "${YELLOW}ğŸ”„ IMPORTANT - To apply all changes:${NC}"
echo "   source ~/.bashrc"
echo ""
echo -e "${YELLOW}ğŸš€ Start using Amazon Q:${NC}"
echo "   q"
echo ""
echo -e "${BLUE}ğŸ’¡ Useful commands:${NC}"
echo "   â€¢ q mcp list          - List all MCP servers"
echo "   â€¢ q settings          - View all settings"
echo "   â€¢ /mcp                - Check MCP status in Q chat"
echo "   â€¢ /tools              - See available tools"
echo "   â€¢ npm list -g --depth=0  - Check installed global packages"
echo ""
echo -e "${BLUE}ğŸ” Try asking Amazon Q:${NC}"
echo "   â€¢ \"Search for recent AI papers on arXiv\""
echo "   â€¢ \"Research the company Anthropic\""
echo "   â€¢ \"Find React hooks examples on GitHub\""
echo "   â€¢ \"Search LinkedIn for AI engineers at Google\""
echo ""
