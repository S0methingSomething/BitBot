name: BitBot Release Announcer

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  build-and-post:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Dependencies
        run: npm install

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Fetch and Parse Release Info
        run: node fetch-release-info.js

      - name: Load Release Info into Environment
        run: |
          echo "BITLIFE_VERSION=$(jq -r .BITLIFE_VERSION release-info.json)" >> $GITHUB_ENV
          echo "DOWNLOAD_URL=$(jq -r .DOWNLOAD_URL release-info.json)" >> $GITHUB_ENV
      
      # The script now communicates its success back to the workflow
      - name: Run Reddit Bot
        id: reddit_bot_step # Give the step an ID to reference its output
        env:
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
          REDDIT_USERNAME: ${{ vars.REDDIT_USERNAME }}
          REDDIT_USER_AGENT: ${{ vars.REDDIT_USER_AGENT }}
          REDDIT_SUBREDDIT: ${{ vars.REDDIT_SUBREDDIT }}
          BITLIFE_VERSION: ${{ env.BITLIFE_VERSION }}
          DOWNLOAD_URL: ${{ env.DOWNLOAD_URL }}
        run: node reddit-bot.js

      # **NEW VERIFICATION STEP**
      # This step only runs if the previous step successfully created a post
      # and passed the URL back as an output.
      - name: Verify Post Creation
        if: steps.reddit_bot_step.outputs.post_url
        run: |
          echo "âœ… Verification successful! Bot confirmed post creation."
          echo "Post URL: ${{ steps.reddit_bot_step.outputs.post_url }}"
