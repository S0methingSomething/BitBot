# This workflow defines the automated process for BitBot.
# It fetches the latest release from BitEdit, parses it, and posts to Reddit.

name: BitBot Release Announcer

on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

  # Runs on a schedule (every 6 hours)
  schedule:
    - cron: '0 */6 * * *'

jobs:
  build-and-post:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Install Dependencies
        run: npm install

      - name: Fetch Latest BitEdit Release
        id: fetch_release
        run: |
          RELEASE_JSON=$(curl -s "https://api.github.com/repos/S0methingSomething/BitEdit/releases/tags/Latest")
          RELEASE_BODY=$(echo "$RELEASE_JSON" | jq -r '.body')
          
          # FIXED: This command is compatible with the GitHub Actions runner environment.
          BITLIFE_VERSION=$(echo "$RELEASE_BODY" | grep -oE '(BitLife v?|compatible with BitLife v?|BitLife version v?)\d+\.\d+(\.\d+)?' | sed -E 's/.*(v|version) ?//')

          if [ -z "$BITLIFE_VERSION" ]; then
            echo "Could not parse BitLife version from release description. Exiting."
            exit 1
          fi
          DOWNLOAD_URL=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name=="MonetizationVars") | .browser_download_url')
          if [ -z "$DOWNLOAD_URL" ]; then
            echo "Could not find MonetizationVars download URL in release assets. Exiting."
            exit 1
          fi
          echo "BITLIFE_VERSION=$BITLIFE_VERSION" >> $GITHUB_ENV
          echo "DOWNLOAD_URL=$DOWNLOAD_URL" >> $GITHUB_ENV
          echo "Release found for BitLife Version: $BITLIFE_VERSION"
          echo "Download URL: $DOWNLOAD_URL"

      - name: Create Reddit Post
        env:
          # Use secrets for private credentials
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
          # Use variables for public configuration
          REDDIT_USERNAME: ${{ vars.REDDIT_USERNAME }}
          REDDIT_USER_AGENT: ${{ vars.REDDIT_USER_AGENT }}
          REDDIT_SUBREDDIT: ${{ vars.REDDIT_SUBREDDIT }}
          # Use environment variables from the previous step
          BITLIFE_VERSION: ${{ env.BITLIFE_VERSION }}
          DOWNLOAD_URL: ${{ env.DOWNLOAD_URL }}
        run: node reddit-bot.js
