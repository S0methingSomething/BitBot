# This workflow is now more robust by separating parsing logic into a Node.js script.

name: BitBot Release Announcer

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  build-and-post:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Dependencies
        run: npm install

      - name: Install jq
        run: sudo apt-get install -y jq

      # Step 1: Run the new script to get release info.
      # This creates the 'release-info.json' file.
      - name: Fetch and Parse Release Info
        run: node fetch-release-info.js

      # Step 2: Load data from the JSON file into environment variables
      # This is the reliable bridge between the Node script and the rest of the workflow.
      - name: Load Release Info into Environment
        run: |
          echo "BITLIFE_VERSION=$(jq -r .BITLIFE_VERSION release-info.json)" >> $GITHUB_ENV
          echo "DOWNLOAD_URL=$(jq -r .DOWNLOAD_URL release-info.json)" >> $GITHUB_ENV
      
      # Step 3: Run the Reddit bot, which now has the correct info.
      - name: Create Reddit Post
        env:
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
          REDDIT_USERNAME: ${{ vars.REDDIT_USERNAME }}
          REDDIT_USER_AGENT: ${{ vars.REDDIT_USER_AGENT }}
          REDDIT_SUBREDDIT: ${{ vars.REDDIT_SUBREDDIT }}
          BITLIFE_VERSION: ${{ env.BITLIFE_VERSION }}
          DOWNLOAD_URL: ${{ env.DOWNLOAD_URL }}
        run: node reddit-bot.js
